{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Transactions</h2>
  <div class="d-flex flex-wrap gap-2">
    <input type="search" id="txSearch" class="form-control" placeholder="Search category/description" style="max-width: 260px;" />
    <select id="txType" class="form-select" style="max-width: 160px;">
      <option value="">All types</option>
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <a href="{{ url_for('transactions.add_transaction') }}" class="btn btn-primary">Add</a>
  </div>
  
</div>
<div class="card">
  <div class="card-body p-0">
    <table class="table mb-0" id="txTable">
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Category</th><th>Description</th><th></th></tr></thead>
      <tbody>
        {% for tx in txs %}
        <tr data-type="{{ tx.type }}">
          <td>{{ tx.date }}</td>
          <td><span class="badge bg-{{ 'success' if tx.type=='income' else 'danger' }}">{{ tx.type }}</span></td>
          <td>{{ '%.2f'|format(tx.amount) }}</td>
          <td class="tx-category">{{ tx.category }}</td>
          <td class="tx-desc">{{ tx.description or '' }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('transactions.edit_transaction', tx_id=tx.id) }}">Edit</a>
            <form action="{{ url_for('transactions.delete_transaction', tx_id=tx.id) }}" method="post" class="d-inline" onsubmit="return confirm('Delete this transaction?')">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="text-center text-muted">No transactions yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card-footer text-muted small" id="txCount"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const table = document.getElementById('txTable');
    if (!table) return;
    const rows = Array.from(table.tBodies[0].rows);
    const search = document.getElementById('txSearch');
    const type = document.getElementById('txType');
    const count = document.getElementById('txCount');
    const apply = () => {
      const q = (search.value || '').toLowerCase();
      const t = (type.value || '').toLowerCase();
      let visible = 0;
      rows.forEach(r => {
        const rtype = (r.getAttribute('data-type') || '').toLowerCase();
        const cat = r.querySelector('.tx-category')?.textContent.toLowerCase() || '';
        const desc = r.querySelector('.tx-desc')?.textContent.toLowerCase() || '';
        const matchType = !t || rtype === t;
        const matchText = !q || cat.includes(q) || desc.includes(q);
        const show = matchType && matchText;
        r.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      if (count) count.textContent = visible + ' transaction' + (visible === 1 ? '' : 's') + ' shown';
    };
    search?.addEventListener('input', apply);
    type?.addEventListener('change', apply);
    apply();
  })();
</script>
{% endblock %}
